<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>舞台の灯 - 参加</title>
  <style>
    body {
      background: #181716 url('https://www.transparenttextures.com/patterns/old-wall.png');
      color: #ebebf6;
      text-align: center;
      font-family: 'Noto Serif JP', serif;
      min-height: 100vh;
      margin: 0;
      box-sizing: border-box;
      filter: sepia(0.07) grayscale(0.08) brightness(0.96);
      position: relative;
    }
    .frame {
      margin: 5em auto 0;
      background:
        linear-gradient(170deg, #39301e 0%, #231e18 80%, #1b1611 100%);
      padding: 2.3em 1.4em 2.1em;
      border-radius: 1.1em 0.7em 2em 1.6em/1.5em 1.7em 2.3em 1.2em;
      border: 2.3px solid #b79b6677;
      box-shadow: 0 5px 42px #31231cbb, 0 0 80px 17px #190d06b6 inset;
      max-width: 420px;
      position: relative;
      /* ボロボロ化, 角をランダムに切る */
      clip-path: polygon(0 0, 100% 0, 100% 94%, 94% 100%, 83% 96%, 74% 100%, 66% 95%, 59% 98%, 54% 95%, 47% 100%, 36% 97%, 29% 100%, 16% 95%, 0 100%);
      filter: grayscale(0.15) sepia(0.13) brightness(0.95);
      overflow: visible;
    }
    h2 {
      color: #ceb26a;
      margin-bottom: .5em;
      font-family: 'Noto Serif JP', serif;
      letter-spacing: .08em;
      text-shadow: 0 2px 8px #59460e60, 0 1px #88793c66;
    }
    .note {
      color: #e1dacb;
      margin: .7em 0 1.8em;
      letter-spacing: .04em;
      font-size: 1.04em;
      text-shadow: 0 1px 2px #3c2d1a44;
    }
    #preview {
      margin-top: 1em;
      border-radius: .7em;
      box-shadow: 0 2px 9px #201815b3, 0 0 0 2px #4b403210;
      border: 2px solid #bca06438;
      background: #000;
      filter: grayscale(.14) sepia(.17) brightness(.88);
    }
    #msg {
      font-size: 1em;
      margin-top: 1.2em;
      color: #eeb2a0;
      letter-spacing: .03em;
      text-shadow: 1px 1px 0 #23181499;
    }
    /* 汚れ/ヒビ・埃の飾り */
    .grunge-corner {
      position: absolute;
      width: 50px;
      height: 42px;
      background:
        radial-gradient(ellipse 50% 27% at 80% 23%, #5d4625cc 48%, transparent 100%),
        repeating-linear-gradient(-20deg, #bca4770a 0 7px, transparent 14px 25px),
        radial-gradient(ellipse 40% 35% at 14% 83%, #96815438 40%, transparent 95%),
        radial-gradient(circle at 60% 72%, #89561e33 6%, transparent 60%);
      opacity: 0.44;
      pointer-events: none;
      z-index: 2;
      filter: blur(0.2px);
    }
    .grunge-corner.cc1 { left: 0; top: 0;}
    .grunge-corner.cc2 { right: 0; top: 0; transform: scaleX(-1);}
    .grunge-corner.cc3 { left: 0; bottom: 0;}
    .grunge-corner.cc4 { right: 0; bottom: 0; transform: scaleX(-1);}
    /* 細かい埃や紙片 */
    .tears {
      position:absolute;
      left:16%; top:91%;
      width: 29px; height: 15px;
      background: 
        conic-gradient(from 14deg at 20% 90%, #e6dec93c 3%, #ab98662e 20%, #2f23185c 90%, transparent 100%);
      opacity:0.38;
      z-index: 10;
      pointer-events: none;
      filter: blur(0.35px);
    }
    @media (max-width:600px) {
      .frame { margin: 2.6em 2vw 0 2vw; padding:1.3em 4vw 1.5em 4vw;}
      h2 { font-size: 1.1em;}
      #preview { width:98vw; max-width:97vw;}
    }
  </style>
</head>
<body>
  <div class="frame">
    <div class="grunge-corner cc1"></div>
    <div class="grunge-corner cc2"></div>
    <div class="grunge-corner cc3"></div>
    <div class="grunge-corner cc4"></div>
    <div class="tears"></div>
    <h2>舞台の灯へ</h2>
    <div class="note">
      代表者の灯（QR）を<br>カメラで読み取ってください。
    </div>
    <video id="preview" width="260" autoplay playsinline ></video>
    <div id="msg"></div>
  </div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsqr/1.4.0/jsQR.min.js"></script>
  <script>
    // ガスURLと参加登録
    const GAS = 'https://script.google.com/macros/s/AKfycbxOhXaHg2WVUpuKDwUjCl4UwuqObFgZzH38MWyOi49lHvg4Pdhw_RlXWhZatpcTSNd8Tw/exec';
    let roomID, userID;
    // もしもう登録済みなら復帰
    if(sessionStorage.getItem('roomID')&&sessionStorage.getItem('userID')){
      roomID = sessionStorage.getItem('roomID');
      userID = sessionStorage.getItem('userID');
    }else{
      const search=location.search; // ?room=xxx のとき用
      // 通常は、代表のQRから値を受け取る
    }
    // QR読取
    const video = document.getElementById('preview');
    const msg = document.getElementById('msg');
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
    .then(stream => {
      video.srcObject = stream;
      const canvas=document.createElement('canvas');
      const ctx=canvas.getContext('2d');
      function scanLoop(){
        if(video.readyState===video.HAVE_ENOUGH_DATA){
          canvas.width=video.videoWidth;canvas.height=video.videoHeight;
          ctx.drawImage(video,0,0,canvas.width,canvas.height);
          const img=ctx.getImageData(0,0,canvas.width,canvas.height);
          const code=jsQR(img.data,img.width,img.height);
          if(code){
            video.srcObject.getTracks().forEach(t=>t.stop());
            // QR内容: roomID:xxxx;leader:xxxx 形式
            let mt = /roomID:([^;]+);leader:([^;]+)/.exec(code.data);
            if(!mt) { msg.textContent="不正なQRです。"; return; }
            roomID = mt[1];
            // まず参加登録
            fetch(`${GAS}?cmd=join&roomID=${roomID}`)
            .then(r=>r.json())
            .then(d=>{
              if(d && d.userID){
                userID = d.userID;
                sessionStorage.setItem('roomID', roomID);
                sessionStorage.setItem('userID', userID);
                // スキャン済み記録
                return fetch(`${GAS}?cmd=scan&roomID=${roomID}&userID=${userID}`);
              }else{
                msg.textContent="この部屋は満員です。";
              }
            }).then(()=>{ 
              msg.innerHTML="参加が完了しました。舞台修復をお待ちください。";
              setTimeout(()=>location.href="restore.html",1600);
            });
          }
        }
        requestAnimationFrame(scanLoop);
      }
      scanLoop();
    })
    .catch(e=>{msg.textContent="カメラがご利用いただけません";});
  </script>
</body>
</html>
